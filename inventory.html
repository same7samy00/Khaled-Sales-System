<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>المخزون - شيخ العرب</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="layout">
    <!-- ✅ الشريط الجانبي -->
    <aside class="sidebar">
      <h2 id="storeLogo" class="logo">شيخ <span>العرب</span></h2>
      <nav class="nav">
        <a href="dashboard.html" class="nav-link"><i class="ri-dashboard-fill"></i> لوحة التحكم</a>
        <a href="inventory.html" class="nav-link active"><i class="ri-archive-fill"></i> المخزون</a>
        <a href="add_product.html" class="nav-link"><i class="ri-add-box-fill"></i> إضافة منتج</a>
        <a href="pos.html" class="nav-link"><i class="ri-cash-register-fill"></i> نقطة البيع</a>
        <a href="sales_history.html" class="nav-link"><i class="ri-file-list-3-fill"></i> سجل المبيعات</a>
        <a href="settings.html" class="nav-link"><i class="ri-settings-5-fill"></i> الإعدادات</a>
      </nav>
      <button id="logoutButton" class="btn btn-logout"><i class="ri-logout-circle-line"></i> خروج</button>
    </aside>

    <!-- ✅ محتوى الصفحة -->
    <main class="main-content">
      <div class="header">
        <h1>المخزون</h1>
        <input type="text" id="searchInput" placeholder="ابحث باسم المنتج..." />
      </div>

      <div id="productsContainer" class="product-grid"></div>
    </main>
  </div>

  <div id="notification-container"></div>

  <script type="module" src="shared.js"></script>
  <script type="module">
    import { db, canEditProducts, canDeleteProducts, showNotification } from "./shared.js";
    import {
      collection,
      onSnapshot,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const productsContainer = document.getElementById("productsContainer");
    const searchInput = document.getElementById("searchInput");

    const productsCol = collection(db, "products");

    onSnapshot(productsCol, (snapshot) => {
      let html = "";

      snapshot.docs.forEach(docSnap => {
        const product = docSnap.data();
        const id = docSnap.id;

        html += `
          <div class="product-card">
            <h3>${product.name}</h3>
            <p>السعر: ${product.price} جنيه</p>
            <p>الكمية: ${product.quantity}</p>
            ${canEditProducts() ? `<a href="add_product.html?edit=${id}" class="btn btn-secondary">تعديل</a>` : ""}
            ${canDeleteProducts() ? `<button class="btn btn-danger" data-id="${id}">حذف</button>` : ""}
          </div>
        `;
      });

      productsContainer.innerHTML = html;

      // ربط أزرار الحذف
      document.querySelectorAll(".btn-danger").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          if (confirm("هل أنت متأكد أنك تريد حذف هذا المنتج؟")) {
            try {
              await deleteDoc(doc(productsCol, id));
              showNotification("تم حذف المنتج بنجاح", "success");
            } catch (error) {
              showNotification("حدث خطأ أثناء الحذف", "error");
              console.error(error);
            }
          }
        });
      });
    });

    searchInput.addEventListener("input", () => {
      const value = searchInput.value.toLowerCase();
      document.querySelectorAll(".product-card").forEach(card => {
        const name = card.querySelector("h3").textContent.toLowerCase();
        card.style.display = name.includes(value) ? "block" : "none";
      });
    });
  </script>
</body>
</html>
